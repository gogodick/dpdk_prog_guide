
# 2. 概述
本章是Data Plane Development Kit (DPDK)的架构概述。

DPDK的主要目的是提供一个简单完整的框架，用于数据面应用的快速报文处理。用户可以使用DPDK代码来理解使用的技术，建立原型系统或者添加他们自己的协议栈。DPDK支持备选的生态系统选项。

DPDK框架为特定环境创建了一系列库，环境抽象层（EAL）可以指定Intel架构，Linux用户态编译器或者特定平台。这些环境是通过使用make文件和configuration文件创建的。创建了EAL库以后，用户可以链接库文件来创建他们自己的应用程序。除了EAL，还提供了其他库，包括Hash，Longest Prefix Match (LPM)和rings。DPDK提供了sample应用，帮助用户使用DPDK的不同功能。

DPDK为报文处理实现了run to completion模型，在运行数据面应用之前，必须分配所有资源，作为执行单元在逻辑core运行。这个模型不支持调度，通过polling访问所有设备。不使用中断的原因是，中断处理带来的性能开销。

除了run-to-completion模型，还有pipleline模型，用来在core之间通过ring传递报文或者消息。这个模型运行分阶段执行工作，可能提高core的代码使用效率。

## 2.1. 开发环境
The DPDK project installation requires Linux and the associated toolchain, such as one or more compilers, assembler, make utility, editor and various libraries to create the DPDK components and libraries.

Once these libraries are created for the specific environment and architecture, they may then be used to create the user’s data plane application.

When creating applications for the Linux user space, the glibc library is used. For DPDK applications, two environmental variables (RTE_SDK and RTE_TARGET) must be configured before compiling the applications. The following are examples of how the variables can be set:

```
export RTE_SDK=/home/user/DPDK
export RTE_TARGET=x86_64-native-linuxapp-gcc
```
See the DPDK Getting Started Guide for information on setting up the development environment.

## 2.2. Environment Abstraction Layer
The Environment Abstraction Layer (EAL) provides a generic interface that hides the environment specifics from the applications and libraries. The services provided by the EAL are:

* DPDK loading and launching
* Support for multi-process and multi-thread execution types
* Core affinity/assignment procedures
* System memory allocation/de-allocation
* Atomic/lock operations
* Time reference
* PCI bus access
* Trace and debug functions
* CPU feature identification
* Interrupt handling
* Alarm operations
* Memory management (malloc)
The EAL is fully described in Environment Abstraction Layer.

## 2.3. Core Components
The core components are a set of libraries that provide all the elements needed for high-performance packet processing applications.

![Fig. 2.1 Core Components Architecture](https://github.com/gogodick/dpdk_prog_guide/blob/master/Image/architecture-overview.svg)

### 2.3.1. Ring Manager (librte_ring)
The ring structure provides a lockless multi-producer, multi-consumer FIFO API in a finite size table. It has some advantages over lockless queues; easier to implement, adapted to bulk operations and faster. A ring is used by the Memory Pool Manager (librte_mempool) and may be used as a general communication mechanism between cores and/or execution blocks connected together on a logical core.

This ring buffer and its usage are fully described in Ring Library.

### 2.3.2. Memory Pool Manager (librte_mempool)
The Memory Pool Manager is responsible for allocating pools of objects in memory. A pool is identified by name and uses a ring to store free objects. It provides some other optional services, such as a per-core object cache and an alignment helper to ensure that objects are padded to spread them equally on all RAM channels.

This memory pool allocator is described in Mempool Library.

### 2.3.3. Network Packet Buffer Management (librte_mbuf)
The mbuf library provides the facility to create and destroy buffers that may be used by the DPDK application to store message buffers. The message buffers are created at startup time and stored in a mempool, using the DPDK mempool library.

This library provides an API to allocate/free mbufs, manipulate control message buffers (ctrlmbuf) which are generic message buffers, and packet buffers (pktmbuf) which are used to carry network packets.

Network Packet Buffer Management is described in Mbuf Library.

### 2.3.4. Timer Manager (librte_timer)
This library provides a timer service to DPDK execution units, providing the ability to execute a function asynchronously. It can be periodic function calls, or just a one-shot call. It uses the timer interface provided by the Environment Abstraction Layer (EAL) to get a precise time reference and can be initiated on a per-core basis as required.

The library documentation is available in Timer Library.

## 2.4. Ethernet* Poll Mode Driver Architecture
The DPDK includes Poll Mode Drivers (PMDs) for 1 GbE, 10 GbE and 40GbE, and para virtualized virtio Ethernet controllers which are designed to work without asynchronous, interrupt-based signaling mechanisms.

See Poll Mode Driver.

## 2.5. Packet Forwarding Algorithm Support
The DPDK includes Hash (librte_hash) and Longest Prefix Match (LPM,librte_lpm) libraries to support the corresponding packet forwarding algorithms.

See Hash Library and LPM Library for more information.

## 2.6. librte_net
The librte_net library is a collection of IP protocol definitions and convenience macros. It is based on code from the FreeBSD* IP stack and contains protocol numbers (for use in IP headers), IP-related macros, IPv4/IPv6 header structures and TCP, UDP and SCTP header structures.
