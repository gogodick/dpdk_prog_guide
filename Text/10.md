# 10. 流量metering和policing的API
## 10.1. 概述
这是以太网设备的服务质量（QoS）的流量metering和policing（MTR）的通用API。这个API不知道底层的实现是硬件，软件或者软硬件结合的。

主要功能是：

* DPDK的rte_ethdev的部分API
* 能力查询API
* metering算法：RFC 2697，单速三色着色器（srTCM），RFC 2698和RFC 4115双速三色着色器（trTCM）
* policer动作（对于meter输出的颜色）：重新着色，丢弃
* 统计（对于policer输出的颜色）
## 10.2. Configuration steps
The metering and policing stage typically sits on top of flow classification, which is why the MTR objects are enabled through a special “meter” action.

The MTR objects are created and updated in their own name space (rte_mtr) within the librte_ether library. Whether an MTR object is private to a flow or potentially shared by several flows has to be specified at its creation time.

Once successfully created, an MTR object is hooked into the RX processing path of the Ethernet device by linking it to one or several flows through the dedicated “meter” flow action. One or several “meter” actions can be registered for the same flow. An MTR object can only be destroyed if there are no flows using it.

## 10.3. Run-time processing
Traffic metering determines the color for the current packet (green, yellow, red) based on the previous history for this flow as maintained by the MTR object. The policer can do nothing, override the color the packet or drop the packet. Statistics counters are maintained for MTR object, as configured.

The processing done for each input packet hitting an MTR object is:

* Traffic metering: The packet is assigned a color (the meter output color) based on the previous traffic history reflected in the current state of the MTR object, according to the specific traffic metering algorithm. The traffic metering algorithm can typically work in color aware mode, in which case the input packet already has an initial color (the input color), or in color blind mode, which is equivalent to considering all input packets initially colored as green.
* Policing: There is a separate policer action configured for each meter output color, which can:
   * Drop the packet.
   * Keep the same packet color: the policer output color matches the meter output color (essentially a no-op action).
   * Recolor the packet: the policer output color is set to a different color than the meter output color. The policer output color is the output color of the packet, which is set in the packet meta-data (i.e. struct rte_mbuf::sched::color).
* Statistics: The set of counters maintained for each MTR object is configurable and subject to the implementation support. This set includes the number of packets and bytes dropped or passed for each output color.
