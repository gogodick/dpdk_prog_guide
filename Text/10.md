# 10. 流量metering和policing的API
## 10.1. 概述
这是以太网设备的服务质量（QoS）的流量metering和policing（MTR）的通用API。这个API不知道底层的实现是硬件，软件或者软硬件结合的。

主要功能是：

* DPDK的rte_ethdev的部分API
* 能力查询API
* metering算法：RFC 2697，单速三色着色器（srTCM），RFC 2698和RFC 4115双速三色着色器（trTCM）
* policer动作（对于meter输出的颜色）：重新着色，丢弃
* 统计（对于policer输出的颜色）
## 10.2. 配置步骤
metering和policing通常是基于流分类执行的，所以MTR的对象通过meter的动作打开。

在librte_ether库中，使用rte_mtr创建和更新MTR对象。在创建时，必须指定MTR对象是流私有的还是几条流共享的。

成功创建MTR对象后，通过流的meter动作关联一条或多条流，从而绑定到以太网设备的RX处理路径。同一条流可以注册一个或多个meter动作。当没有流使用MTR对象时，才能删除这个对象。

## 10.3. 实时处理
Traffic metering determines the color for the current packet (green, yellow, red) based on the previous history for this flow as maintained by the MTR object. The policer can do nothing, override the color the packet or drop the packet. Statistics counters are maintained for MTR object, as configured.

The processing done for each input packet hitting an MTR object is:

* Traffic metering: The packet is assigned a color (the meter output color) based on the previous traffic history reflected in the current state of the MTR object, according to the specific traffic metering algorithm. The traffic metering algorithm can typically work in color aware mode, in which case the input packet already has an initial color (the input color), or in color blind mode, which is equivalent to considering all input packets initially colored as green.
* Policing: There is a separate policer action configured for each meter output color, which can:
   * Drop the packet.
   * Keep the same packet color: the policer output color matches the meter output color (essentially a no-op action).
   * Recolor the packet: the policer output color is set to a different color than the meter output color. The policer output color is the output color of the packet, which is set in the packet meta-data (i.e. struct rte_mbuf::sched::color).
* Statistics: The set of counters maintained for each MTR object is configurable and subject to the implementation support. This set includes the number of packets and bytes dropped or passed for each output color.
